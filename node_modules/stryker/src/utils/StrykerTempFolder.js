"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var fs = require("mz/fs");
var path = require("path");
var mkdirp = require("mkdirp");
var log4js_1 = require("log4js");
var fileUtils_1 = require("./fileUtils");
var baseTempFolder = path.join(process.cwd(), '.stryker-tmp');
var tempFolder = path.join(baseTempFolder, random().toString());
mkdirp.sync(baseTempFolder);
mkdirp.sync(tempFolder);
/**
 * Creates a new random folder with the specified prefix.
 * @param prefix The prefix.
 * @returns The path to the folder.
 */
function createRandomFolder(prefix) {
    var dir = tempFolder + path.sep + prefix + random();
    mkdirp.sync(dir);
    return dir;
}
/**
 * Creates a random integer number.
 * @returns A random integer.
 */
function random() {
    return Math.ceil(Math.random() * 10000000);
}
/**
 * Writes data to a specified file.
 * @param fileName The path to the file.
 * @param data The content of the file.
 * @returns A promise to eventually save the file.
 */
function writeFile(fileName, data, instrumenter) {
    if (instrumenter === void 0) { instrumenter = null; }
    if (Buffer.isBuffer(data)) {
        return fs.writeFile(fileName, data);
    }
    else if (instrumenter) {
        instrumenter.pipe(fs.createWriteStream(fileName, 'utf8'));
        return writeToStream(data, instrumenter);
    }
    else {
        return fs.writeFile(fileName, data, 'utf8');
    }
}
function writeToStream(data, stream) {
    return new Promise(function (res, rej) {
        stream.end(data, function (err) {
            if (err) {
                rej(err);
            }
            else {
                res();
            }
        });
    });
}
/**
 * Deletes the Stryker-temp folder
 */
function clean() {
    var log = log4js_1.getLogger('StrykerTempFolder');
    log.debug("Cleaning stryker temp folder " + baseTempFolder);
    return fileUtils_1.deleteDir(baseTempFolder)
        .catch(function () { return log.info("Failed to clean stryker temp folder " + baseTempFolder); });
}
exports.default = {
    createRandomFolder: createRandomFolder,
    writeFile: writeFile,
    clean: clean
};
//# sourceMappingURL=StrykerTempFolder.js.map